<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Snake</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{
  width:100%;height:100%;overflow:hidden;
  background:#4a7c20;
  font-family:'Nunito',sans-serif;
  touch-action:none;user-select:none;
}
#shell{
  width:100%;height:100%;
  display:flex;flex-direction:column;align-items:center;
  background:#4a7c20;
}
/* HEADER */
#hdr{
  width:100%;height:46px;flex-shrink:0;
  background:#3a5f12;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;
  box-shadow:0 3px 8px rgba(0,0,0,.3);
}
.hi{display:flex;align-items:center;gap:6px;color:#fff;font-size:17px;font-weight:800;}
.hi span:first-child{font-size:20px;}
#lv-label{color:rgba(255,255,255,.7);font-size:11px;font-weight:800;letter-spacing:1.2px;text-transform:uppercase;}
#back-btn{
  background:rgba(255,255,255,.18);border:none;border-radius:10px;
  color:#fff;font-size:12px;font-weight:800;
  padding:5px 11px;cursor:pointer;
  font-family:'Nunito',sans-serif;
  letter-spacing:.5px;
  transition:background .12s,transform .08s;
  display:none;
}
#back-btn.vis{display:block;}
#back-btn:active{background:rgba(255,255,255,.32);transform:scale(.95);}
/* BOARD */
#board-area{
  flex:1;display:flex;align-items:center;justify-content:center;
  width:100%;overflow:hidden;
  min-height:0;
}
#board-frame{
  position:relative;flex-shrink:0;
  border-radius:5px;overflow:hidden;
  box-shadow:0 0 0 4px #3a5f12, 0 0 0 7px #2b4610, 0 8px 24px rgba(0,0,0,.45);
}
canvas{display:block;}
/* OVERLAYS */
.ovl{
  position:absolute;inset:0;z-index:30;
  display:none;flex-direction:column;
  align-items:center;justify-content:center;
  gap:12px;padding:14px;
  background:rgba(18,36,4,.84);
  border-radius:5px;
}
.ovl.on{display:flex;}
/* MENU */
.m-title{color:#fff;font-size:21px;font-weight:900;text-transform:uppercase;letter-spacing:2px;
  text-shadow:0 2px 8px rgba(0,0,0,.5);}
.m-sub{color:rgba(255,255,255,.5);font-size:10px;font-weight:700;letter-spacing:1px;margin-top:-6px;}
.lv-list{display:flex;flex-direction:column;gap:7px;width:100%;}
.lv{
  background:#fff;border-radius:13px;
  padding:9px 13px;
  display:flex;align-items:center;gap:10px;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.2);
  border-left:4px solid var(--c);
  transition:transform .09s;
}
.lv:active{transform:scale(.97);}
.lv:hover{transform:translateY(-2px);}
.lv[data-lv="0"]{--c:#e05252;} .lv[data-lv="1"]{--c:#f5a623;} .lv[data-lv="2"]{--c:#4a90e9;}
.lv-badge{width:32px;height:32px;border-radius:50%;background:var(--c);color:#fff;
  font-size:15px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.lv-name{font-size:13px;font-weight:900;color:#222;text-transform:uppercase;letter-spacing:.4px;}
.lv-desc{font-size:10px;color:#999;margin-top:1px;line-height:1.35;}
.lv-ico{margin-left:auto;font-size:20px;}
/* GO */
.pop-card{
  background:#fff;border-radius:18px;padding:26px 34px;text-align:center;
  box-shadow:0 12px 36px rgba(0,0,0,.55);
  animation:pop .22s cubic-bezier(.34,1.56,.64,1) both;
}
.go-title{font-size:26px;font-weight:900;color:#333;}
.go-score{font-size:52px;font-weight:900;color:#e05252;line-height:1.1;}
.go-best{font-size:12px;color:#bbb;margin-top:2px;}
.go-restart{font-size:11px;color:#ccc;margin-top:8px;}
/* LC */
.lc-title{font-size:24px;font-weight:900;color:#3a7000;}
.lc-sub{font-size:12px;color:#888;margin-top:6px;}
.lc-btn{
  margin-top:14px;background:#3a7000;color:#fff;
  border:none;border-radius:999px;padding:11px 28px;
  font-size:14px;font-weight:800;cursor:pointer;
  font-family:'Nunito',sans-serif;
  box-shadow:0 4px 0 #275000;
  transition:transform .08s,box-shadow .08s;
}
.lc-btn:active{transform:translateY(3px);box-shadow:0 1px 0 #275000;}
/* flip flash */
#rflash{
  position:absolute;inset:0;z-index:22;pointer-events:none;
  background:radial-gradient(ellipse at center,rgba(255,200,0,.65),rgba(255,130,0,.15));
  opacity:0;border-radius:5px;
}
/* DPAD */
#dpad-wrap{
  flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  padding:10px 0 16px;
}
#dpad{
  display:grid;
  grid-template:". U ." "L . R" ". D .";
  grid-template-columns:min(22vw,96px) min(22vw,96px) min(22vw,96px);
  grid-template-rows:min(22vw,96px) min(22vw,96px) min(22vw,96px);
  gap:8px;
}
.dp{
  background:#fff;border:none;border-radius:20px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  box-shadow:0 7px 0 #2c6d00, 0 10px 20px rgba(0,0,0,.3);
  transition:box-shadow .06s,transform .06s;
  touch-action:none;
  -webkit-user-select:none;
}
.dp:active,.dp.pr{
  box-shadow:0 2px 0 #2c6d00, 0 4px 8px rgba(0,0,0,.2);
  transform:translateY(5px);
}
.dp svg{width:min(11vw,48px);height:min(11vw,48px);fill:#3a7000;}
#dp-U{grid-area:U;} #dp-L{grid-area:L;} #dp-R{grid-area:R;} #dp-D{grid-area:D;}
@keyframes pop{from{opacity:0;transform:scale(.6);}to{opacity:1;transform:scale(1);}}
</style>
</head>
<body>
<div id="shell">
  <div id="hdr">
    <div class="hi"><span>üçé</span><span id="sc">0</span></div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:2px;">
      <div id="lv-label">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
      <button id="back-btn">‚Üê LEVELS</button>
    </div>
    <div class="hi"><span>üèÜ</span><span id="hi">0</span></div>
  </div>

  <div id="board-area">
    <div id="board-frame">
      <div id="rflash"></div>
      <canvas id="gc"></canvas>

      <!-- MENU -->
      <div class="ovl on" id="m-ovl">
        <div class="m-title">Snake</div>
        <div class="m-sub">SELECT A LEVEL</div>
        <div class="lv-list">
          <div class="lv" data-lv="0">
            <div class="lv-badge">1</div>
            <div><div class="lv-name">Closing In</div><div class="lv-desc">Walls grow with every apple eaten</div></div>
            <span class="lv-ico">üß±</span>
          </div>
          <div class="lv" data-lv="1">
            <div class="lv-badge">2</div>
            <div><div class="lv-name">Flipside</div><div class="lv-desc">Apple instantly reverses snake direction</div></div>
            <span class="lv-ico">üîÑ</span>
          </div>
          <div class="lv" data-lv="2">
            <div class="lv-badge">3</div>
            <div><div class="lv-name">Gauntlet</div><div class="lv-desc">Navigate the deadly fixed maze</div></div>
            <span class="lv-ico">üåÄ</span>
          </div>
        </div>
      </div>

      <!-- GAME OVER -->
      <div class="ovl" id="go-ovl">
        <div class="pop-card">
          <div class="go-title">Game Over</div>
          <div class="go-score" id="go-sc">0</div>
          <div class="go-best" id="go-best"></div>
          <div class="go-restart">Restarting in <span id="go-cnt">2</span>s‚Ä¶</div>
        </div>
      </div>

      <!-- LEVEL COMPLETE -->
      <div class="ovl" id="lc-ovl">
        <div class="pop-card">
          <div class="lc-title">üéâ Level Clear!</div>
          <div class="lc-sub" id="lc-sub"></div>
          <button class="lc-btn" id="lc-btn">Next Level ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DPAD -->
  <div id="dpad-wrap">
    <div id="dpad">
      <button class="dp" id="dp-U"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button>
      <button class="dp" id="dp-L"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L10.83 12l4.58 4.59L14 18l-6-6 6-6z"/></svg></button>
      <button class="dp" id="dp-R"><svg viewBox="0 0 24 24"><path d="M10 6l-1.41 1.41L13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
      <button class="dp" id="dp-D"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg></button>
    </div>
  </div>
</div>

<script>
const cvs = document.getElementById('gc');
const ctx  = cvs.getContext('2d');
const rFlash = document.getElementById('rflash');

const GN = 14;
let   GS = 30;

let state = 'MENU';
let snake, snakePrev, dir, nextDir;
let foods, walls;
let score=0, hiScore=0, curLevel=0;
let tickMs=220, tickId=null;
let lastTick=0, dirLock=false;
let rafId=null, T=0;

let particles=[], shockwaves=[];
let eatBounce=1, eatBounceV=0;
let bodyGlow=0, revGlow=0;
let shakeT=0, shakeX=0, shakeY=0;
let blinkT=0, nextBlink=Date.now()+2200;
const BLINK_DUR=110;

const LV = [
  { name:'CLOSING IN', type:'closein', clr:'#e05252', spd:220, min:85,  step:5 },
  { name:'FLIPSIDE',   type:'reverse', clr:'#f5a623', spd:235, min:90,  step:4 },
  { name:'GAUNTLET',   type:'maze',    clr:'#4a90e9', spd:250, min:100, step:5,
    grid:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,1,1,1,0,0,0,0,1,1,1,0,1],
      [1,0,1,0,0,0,0,0,0,0,0,1,0,1],
      [1,0,1,0,1,1,0,0,1,1,0,1,0,1],
      [1,0,0,0,1,0,0,0,0,1,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,1,0,0,0,0,1,0,0,0,1],
      [1,0,1,0,1,1,0,0,1,1,0,1,0,1],
      [1,0,1,0,0,0,0,0,0,0,0,1,0,1],
      [1,0,1,1,1,0,0,0,0,1,1,1,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ]
  }
];

let AC, audioOn=false;
function initA(){
  if(audioOn)return;
  try{AC=new(window.AudioContext||window.webkitAudioContext)();audioOn=true;}catch(e){}
}
function tone(f,type,dur,vol=0.09,fend){
  if(!audioOn)return;
  try{
    const o=AC.createOscillator(),g=AC.createGain();
    o.connect(g);g.connect(AC.destination);
    o.type=type;o.frequency.setValueAtTime(f,AC.currentTime);
    if(fend)o.frequency.exponentialRampToValueAtTime(fend,AC.currentTime+dur);
    g.gain.setValueAtTime(vol,AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+dur);
    o.start();o.stop(AC.currentTime+dur);
  }catch(e){}
}
const sfxEat    = ()=>{tone(523,'sine',.07,.18);setTimeout(()=>tone(784,'sine',.06,.11),55);};
const sfxFlip   = ()=>{tone(880,'sine',.06,.1);setTimeout(()=>tone(440,'sawtooth',.2,.07,110),70);};
const sfxWall   = ()=>tone(110,'square',.12,.05);
const sfxDie    = ()=>{tone(440,'sawtooth',.55,.14,75);setTimeout(()=>tone(180,'sawtooth',.3,.08,60),130);};
const sfxStart  = ()=>[330,440,660].forEach((f,i)=>setTimeout(()=>tone(f,'square',.1,.07),i*80));
const sfxNear   = ()=>tone(1400,'sine',.04,.035);

// ‚îÄ‚îÄ Layout ‚Äî wait for full paint so dpad height is accurate ‚îÄ‚îÄ
function layout(){
  const hdrH   = document.getElementById('hdr').offsetHeight || 46;
  const dpadEl = document.getElementById('dpad-wrap');
  const dpadH  = dpadEl.offsetHeight || 220;
  const vPad   = 24;
  const availH = window.innerHeight - hdrH - dpadH - vPad;
  const availW = window.innerWidth  - 16;
  GS = Math.max(12, Math.min(Math.floor(availH / GN), Math.floor(availW / GN)));

  const W = GN * GS;
  const H = GN * GS;
  cvs.width  = W;
  cvs.height = H;

  // Size the frame so the overlay covers the canvas exactly
  const frame = document.getElementById('board-frame');
  frame.style.width  = W + 'px';
  frame.style.height = H + 'px';

  drawFrame();
}

const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const eio=t=>t<.5?2*t*t:-1+(4-2*t)*t;
const rndInt=(lo,hi)=>Math.floor(Math.random()*(hi-lo))+lo;

function hitWall(p){
  const lv=LV[curLevel];
  if(lv.type==='maze'){
    if(p.x<0||p.x>=GN||p.y<0||p.y>=GN)return true;
    return lv.grid[p.y][p.x]===1;
  }
  if(p.x<1||p.x>=GN-1||p.y<1||p.y>=GN-1)return true;
  if(lv.type==='closein'&&walls.some(w=>w.x===p.x&&w.y===p.y))return true;
  return false;
}
function hitSelf(p,skip=0){
  for(let i=skip;i<snake.length;i++)if(snake[i].x===p.x&&snake[i].y===p.y)return true;
  return false;
}

function freeSpot(){
  const lv=LV[curLevel];
  if(lv.type==='maze'){
    const empties=[];
    for(let r=1;r<GN-1;r++)for(let c=1;c<GN-1;c++){
      if(lv.grid[r][c]===0&&!snake.some(s=>s.x===c&&s.y===r)&&!foods.some(f=>f.x===c&&f.y===r))
        empties.push({x:c,y:r});
    }
    return empties.length?empties[rndInt(0,empties.length)]:null;
  }
  for(let t=0;t<3000;t++){
    const p={x:rndInt(1,GN-1),y:rndInt(1,GN-1)};
    if(!snake.some(s=>s.x===p.x&&s.y===p.y)&&
       !walls.some(w=>w.x===p.x&&w.y===p.y)&&
       !foods.some(f=>f.x===p.x&&f.y===p.y))return p;
  }
  return null;
}
function manageFood(){
  const want=snake.length>20?3:snake.length>10?2:1;
  while(foods.length<want){const s=freeSpot();if(s)foods.push(s);else break;}
}

function startLv(idx){
  initA();sfxStart();
  curLevel=idx;score=0;
  doLoad();
}
function doLoad(){
  const lv=LV[curLevel];
  // Pick a safe start cell ‚Äî for maze, find first open interior cell
  let sx=5, sy=3;
  if(lv.type==='maze'){
    outer:for(let r=1;r<GN-1;r++)for(let c=3;c<GN-1;c++){if(lv.grid[r][c]===0&&lv.grid[r][c-1]===0&&lv.grid[r][c-2]===0){sy=r;sx=c;break outer;}}
  }
  // Start with head + body + tail (3 segments, pointing right)
  snake=[{x:sx,y:sy},{x:sx-1,y:sy},{x:sx-2,y:sy}];
  snakePrev=[{x:sx,y:sy},{x:sx-1,y:sy},{x:sx-2,y:sy}];
  dir={x:1,y:0};nextDir={x:0,y:0};
  foods=[];walls=[];particles=[];shockwaves=[];
  eatBounce=1;eatBounceV=0;bodyGlow=0;revGlow=0;
  shakeT=0;dirLock=false;tickMs=lv.spd;
  manageFood();
  state='PLAYING';
  closeOvl();
  lastTick=Date.now();
  clearInterval(tickId);
  tickId=setInterval(tick,tickMs);
  updateHdr();
}

function tick(){
  if(state!=='PLAYING')return;
  dirLock=false;
  snakePrev=snake.map(s=>({...s}));
  lastTick=Date.now();

  if(nextDir.x!==0||nextDir.y!==0){
    const rev=snake.length>1&&(nextDir.x===-dir.x||nextDir.y===-dir.y);
    if(!rev)dir={...nextDir};
    nextDir={x:0,y:0};
  }

  const head={x:snake[0].x+dir.x,y:snake[0].y+dir.y};
  if(hitWall(head)||hitSelf(head,1)){die();return;}

  snake.unshift(head);
  const eatIdx=foods.findIndex(f=>f.x===head.x&&f.y===head.y);

  if(eatIdx!==-1){
    sfxEat();
    score+=10;if(score>hiScore)hiScore=score;
    foods.splice(eatIdx,1);
    eatBounceV=0.14;bodyGlow=1;
    emitEat(head.x,head.y);

    const lv=LV[curLevel];
    if(lv.type==='closein')spawnWall();
    else if(lv.type==='reverse')doReverse();
    else if(lv.type==='maze'){
      const total=lv.grid.flat().filter(c=>c===0).length;
      if(snake.length>=total){lvDone();return;}
    }
    speedUp();updateHdr();manageFood();
  } else {
    snake.pop();
  }
  const h=snake[0];
  if(foods.some(f=>Math.abs(f.x-h.x)+Math.abs(f.y-h.y)===1))sfxNear();
}

function die(){
  sfxDie();emitDeath(snake[0].x,snake[0].y);
  shakeT=0.55;clearInterval(tickId);state='GO';
  try{localStorage.setItem('snakeHi',hiScore);}catch(e){}
  document.getElementById('go-sc').textContent=score;
  document.getElementById('go-best').textContent=`Best: ${hiScore}`;
  document.getElementById('go-ovl').classList.add('on');
  let c=2;document.getElementById('go-cnt').textContent=c;
  const iv=setInterval(()=>{
    c--;document.getElementById('go-cnt').textContent=c;
    if(c<=0){
      clearInterval(iv);
      document.getElementById('go-ovl').classList.remove('on');
      if(state==='GO'){score=0;doLoad();}
    }
  },1000);
}

function lvDone(){
  clearInterval(tickId);state='LC';
  document.getElementById('lc-ovl').classList.add('on');
  document.getElementById('lc-sub').textContent=`Score: ${score} pts üèÜ`;
  const btn=document.getElementById('lc-btn');
  const nxt=curLevel+1;
  if(nxt<LV.length){
    btn.textContent='Next Level ‚Üí';
    btn.onclick=()=>{score=0;curLevel=nxt;doLoad();};
  } else {
    btn.textContent='üèÜ Play Again';
    btn.onclick=()=>{score=0;curLevel=0;doLoad();};
  }
}

function doReverse(){
  sfxFlip();
  snake.reverse();
  snakePrev=snake.map(s=>({...s}));
  if(snake.length>1)dir={x:snake[0].x-snake[1].x,y:snake[0].y-snake[1].y};
  else dir={x:-dir.x,y:-dir.y};
  nextDir={x:0,y:0};
  revGlow=1;
  rFlash.style.transition='none';
  rFlash.style.opacity='1';
  requestAnimationFrame(()=>{
    rFlash.style.transition='opacity .42s';
    rFlash.style.opacity='0';
  });
  snake.forEach((s,i)=>{if(i%2===0)emitWarp(s.x,s.y);});
}

function spawnWall(){
  const lim=(GN-2)*(GN-2)-snake.length-foods.length-6;
  if(walls.length<lim){
    const w=freeSpot();
    if(w){walls.push(w);sfxWall();shockwaves.push({x:w.x,y:w.y,t:0});}
  }
}

function speedUp(){
  const lv=LV[curLevel];
  const ns=Math.max(lv.min,lv.spd-Math.floor(score/20)*lv.step);
  if(ns!==tickMs){tickMs=ns;clearInterval(tickId);tickId=setInterval(tick,tickMs);}
}

function emitEat(gx,gy){
  const cx=gx*GS+GS/2,cy=gy*GS+GS/2;
  for(let i=0;i<14;i++){
    const a=Math.random()*Math.PI*2,sp=1.5+Math.random()*4;
    particles.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      life:0.7+Math.random()*.4,sz:2+Math.random()*3,col:`hsl(${rndInt(80,140)},90%,60%)`});
  }
}
function emitDeath(gx,gy){
  const cx=gx*GS+GS/2,cy=gy*GS+GS/2;
  for(let i=0;i<28;i++){
    const a=Math.random()*Math.PI*2,sp=2+Math.random()*7;
    particles.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      life:0.8+Math.random()*.6,sz:3+Math.random()*5,col:`hsl(${rndInt(0,40)},95%,55%)`});
  }
}
function emitWarp(gx,gy){
  const cx=gx*GS+GS/2,cy=gy*GS+GS/2;
  for(let i=0;i<5;i++){
    const a=Math.random()*Math.PI*2,sp=.5+Math.random()*3;
    particles.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      life:.5+Math.random()*.3,sz:2+Math.random()*2.5,col:'hsl(40,100%,60%)'});
  }
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawFrame(){
  if(!cvs.width || !cvs.height) return;
  T=Date.now()*.001;

  eatBounceV-=(eatBounce-1)*.38;eatBounceV*=.7;
  eatBounce=clamp(eatBounce+eatBounceV,.75,1.28);
  if(bodyGlow>0)bodyGlow=Math.max(0,bodyGlow-.028);
  if(revGlow>0)revGlow=Math.max(0,revGlow-.035);
  if(shakeT>0){
    shakeT=Math.max(0,shakeT-.045);
    shakeX=shakeT>0?(Math.random()-.5)*GS*.38*shakeT:0;
    shakeY=shakeT>0?(Math.random()-.5)*GS*.38*shakeT:0;
  }else{shakeX=shakeY=0;}

  ctx.save();
  ctx.translate(shakeX,shakeY);
  drawBoard();
  drawWalls();
  drawShockwaves();
  if(state==='PLAYING'||state==='GO'){
    drawFood();
    drawSnake();
    drawParticles();
  }
  ctx.restore();
}

function drawBoard(){
  for(let r=0;r<GN;r++)for(let c=0;c<GN;c++){
    ctx.fillStyle=(r+c)%2===0?'#aad751':'#a2d049';
    ctx.fillRect(c*GS,r*GS,GS,GS);
  }
}

const WP=[[0,1,2,1],[1,2,1,0],[2,1,0,1],[1,0,1,2]];
const WC=['#578a00','#4a7800','#3c6300'];
function wCell(x,y){
  const P=GS/4;
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    ctx.fillStyle=WC[WP[r][c]];ctx.fillRect(x+c*P,y+r*P,P,P);
  }
}
function drawWalls(){
  if(!state||state==='MENU') return;
  const lv=LV[curLevel];
  if(lv.type==='maze'){
    lv.grid.forEach((row,r)=>row.forEach((cell,c)=>{if(cell===1)wCell(c*GS,r*GS);}));
  } else {
    for(let i=0;i<GN;i++){
      wCell(i*GS,0);wCell(i*GS,(GN-1)*GS);
      if(i>0&&i<GN-1){wCell(0,i*GS);wCell((GN-1)*GS,i*GS);}
    }
    walls.forEach(w=>wCell(w.x*GS,w.y*GS));
  }
}

function drawShockwaves(){
  shockwaves=shockwaves.filter(s=>s.t<1);
  shockwaves.forEach(s=>{
    s.t+=.055;const a=(1-s.t)*.8,r=s.t*GS*6;
    ctx.save();
    ctx.strokeStyle=`rgba(190,255,70,${a})`;ctx.lineWidth=2.5;
    ctx.shadowBlur=12;ctx.shadowColor=`rgba(150,255,0,${a})`;
    ctx.beginPath();ctx.arc(s.x*GS+GS/2,s.y*GS+GS/2,r,0,Math.PI*2);ctx.stroke();
    ctx.restore();
  });
}

function drawFood(){
  const pulse=1+Math.sin(T*5)*.045;
  foods.forEach(f=>{
    const fx=f.x*GS+GS/2,fy=f.y*GS+GS/2,r=GS*.4*pulse;
    ctx.save();
    ctx.shadowColor='rgba(80,0,0,.35)';ctx.shadowBlur=10;ctx.shadowOffsetY=3;
    ctx.fillStyle='#e02020';
    ctx.beginPath();ctx.arc(fx,fy,r,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.shadowOffsetY=0;
    ctx.fillStyle='rgba(255,130,130,.6)';
    ctx.beginPath();ctx.ellipse(fx-r*.24,fy-r*.28,r*.38,r*.26,-.3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,220,220,.75)';
    ctx.beginPath();ctx.arc(fx-r*.1,fy-r*.36,r*.14,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#5a3200';ctx.lineWidth=Math.max(1.5,GS*.07);ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(fx+r*.06,fy-r*.82);
    ctx.quadraticCurveTo(fx+r*.55,fy-r*1.4,fx+r*.38,fy-r*1.0);ctx.stroke();
    ctx.fillStyle='#4caf50';
    ctx.beginPath();ctx.ellipse(fx+r*.3,fy-r*.98,r*.3,r*.17,.5,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });
}

function drawSnake(){
  if(!snake||!snake.length)return;
  const elapsed=Date.now()-lastTick;
  const et=eio(clamp(elapsed/tickMs,0,1));

  const pts=snake.map((s,i)=>{
    const p=snakePrev[i]||snakePrev[snakePrev.length-1]||s;
    return{x:lerp(p.x,s.x,et)*GS+GS/2, y:lerp(p.y,s.y,et)*GS+GS/2};
  });

  const sw=GS*.80*eatBounce;

  // Shadow
  ctx.save();ctx.translate(0,GS*.09);
  drawCurve(pts,sw*1.1,'rgba(0,0,0,.18)');ctx.restore();

  // Glow
  const g=Math.max(bodyGlow,revGlow);
  if(g>.01){
    ctx.save();
    ctx.shadowBlur=16+g*14;
    ctx.shadowColor=revGlow>bodyGlow?`rgba(255,180,0,${g*.85})`:`rgba(60,170,255,${g*.85})`;
    drawCurve(pts,sw*1.2,`rgba(0,60,200,${g*.12})`);ctx.restore();
  }

  drawCurve(pts,sw,'#1a45a0');
  drawCurve(pts,sw*.82,'#4a8ae8');
  drawCurve(pts,sw*.29,`rgba(185,215,255,${.42+Math.sin(T*2.2)*.1})`);

  drawHead(pts);
}

// Smooth snake body using quadratic bezier midpoint technique
function drawCurve(pts,lw,col){
  if(pts.length<2)return;
  ctx.save();
  ctx.strokeStyle=col;ctx.lineWidth=lw;
  ctx.lineCap='round';ctx.lineJoin='round';
  ctx.beginPath();
  ctx.moveTo(pts[0].x,pts[0].y);
  if(pts.length===2){
    ctx.lineTo(pts[1].x,pts[1].y);
  } else {
    // From head to first midpoint
    const m0x=(pts[0].x+pts[1].x)*.5;
    const m0y=(pts[0].y+pts[1].y)*.5;
    ctx.lineTo(m0x,m0y);
    for(let i=1;i<pts.length-1;i++){
      const mx=(pts[i].x+pts[i+1].x)*.5;
      const my=(pts[i].y+pts[i+1].y)*.5;
      ctx.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);
    }
    ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);
  }
  ctx.stroke();ctx.restore();
}

function drawHead(pts){
  if(!pts.length)return;
  const hx=pts[0].x,hy=pts[0].y;
  const r=(GS*.80/2)*eatBounce;
  const eo=getEO();
  const eR=r*.37,eOff=r*.43;
  const d=(dir.x===0&&dir.y===0)?{x:1,y:0}:dir;
  let e1x,e1y,e2x,e2y;
  if(d.x===1)      {e1x=hx+r*.08;e1y=hy-eOff;e2x=hx+r*.08;e2y=hy+eOff;}
  else if(d.x===-1){e1x=hx-r*.08;e1y=hy-eOff;e2x=hx-r*.08;e2y=hy+eOff;}
  else if(d.y===1) {e1x=hx-eOff;e1y=hy+r*.08;e2x=hx+eOff;e2y=hy+r*.08;}
  else             {e1x=hx-eOff;e1y=hy-r*.08;e2x=hx+eOff;e2y=hy-r*.08;}

  [[e1x,e1y],[e2x,e2y]].forEach(([ex,ey])=>{
    const eH=Math.max(eR*.06,eR*eo);
    ctx.save();
    ctx.fillStyle='white';
    ctx.shadowBlur=3;ctx.shadowColor='rgba(0,0,0,.25)';
    ctx.beginPath();ctx.ellipse(ex,ey,eR,eH,0,0,Math.PI*2);ctx.fill();
    if(eo>.08){
      ctx.shadowBlur=0;
      ctx.fillStyle='#111';
      ctx.beginPath();ctx.ellipse(ex+d.x*eR*.22,ey+d.y*eR*.22,eR*.55,eH*.65,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.75)';
      ctx.beginPath();ctx.arc(ex-eR*.18,ey-eH*.3,eR*.19,0,Math.PI*2);ctx.fill();
    }
    ctx.restore();
  });
}
function getEO(){
  const now=Date.now();
  if(now>nextBlink){blinkT=now;nextBlink=now+BLINK_DUR+1400+Math.random()*2800;}
  const t=(now-blinkT)/BLINK_DUR;
  if(t>=0&&t<=1)return t<.5?1-t*2:(t-.5)*2;
  return 1;
}

function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vx*=.85;p.vy*=.85;p.vy+=.07;p.life-=.028;
    if(p.life<=0){particles.splice(i,1);continue;}
    ctx.globalAlpha=clamp(p.life,0,1);
    ctx.fillStyle=p.col;
    ctx.fillRect(p.x-p.sz/2,p.y-p.sz/2,p.sz,p.sz);
    ctx.globalAlpha=1;
  }
}

function startRAF(){
  function f(){drawFrame();rafId=requestAnimationFrame(f);}
  if(rafId)cancelAnimationFrame(rafId);
  rafId=requestAnimationFrame(f);
}

function setDir(d){
  initA();
  if(state!=='PLAYING')return;
  if(snake.length>1&&(d.x===-dir.x||d.y===-dir.y))return;
  if(!dirLock){nextDir={...d};dirLock=true;}
}

function bindDP(id,d){
  const el=document.getElementById(id);
  el.addEventListener('pointerdown',e=>{e.preventDefault();setDir(d);el.classList.add('pr');},{passive:false});
  el.addEventListener('pointerup',  ()=>el.classList.remove('pr'),{passive:true});
  el.addEventListener('pointercancel',()=>el.classList.remove('pr'),{passive:true});
  el.addEventListener('pointerleave',()=>el.classList.remove('pr'),{passive:true});
}
bindDP('dp-U',{x:0,y:-1});
bindDP('dp-D',{x:0,y:1});
bindDP('dp-L',{x:-1,y:0});
bindDP('dp-R',{x:1,y:0});

window.addEventListener('keydown',e=>{
  initA();
  if(state==='MENU'){
    if(e.key==='1'){closeOvl();startLv(0);}
    if(e.key==='2'){closeOvl();startLv(1);}
    if(e.key==='3'){closeOvl();startLv(2);}
    return;
  }
  const map={ArrowUp:'U',w:'U',ArrowDown:'D',s:'D',ArrowLeft:'L',a:'L',ArrowRight:'R',d:'R'};
  const dirs={U:{x:0,y:-1},D:{x:0,y:1},L:{x:-1,y:0},R:{x:1,y:0}};
  if(map[e.key])setDir(dirs[map[e.key]]);
});

let tx=0,ty=0;
cvs.addEventListener('touchstart',e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY;},{passive:true});
cvs.addEventListener('touchend',e=>{
  initA();
  const dx=e.changedTouches[0].clientX-tx,dy=e.changedTouches[0].clientY-ty;
  Math.abs(dx)>Math.abs(dy)?setDir(dx>0?{x:1,y:0}:{x:-1,y:0}):setDir(dy>0?{x:0,y:1}:{x:0,y:-1});
},{passive:true});

document.querySelectorAll('.lv').forEach(card=>{
  card.addEventListener('pointerdown',e=>{
    e.preventDefault();initA();closeOvl();startLv(parseInt(card.dataset.lv));
  },{passive:false});
});

function closeOvl(){
  ['m-ovl','go-ovl','lc-ovl'].forEach(id=>document.getElementById(id).classList.remove('on'));
}
function showMenu(){
  clearInterval(tickId);
  state='MENU';
  score=0;
  document.getElementById('m-ovl').classList.add('on');
  document.getElementById('back-btn').classList.remove('vis');
  document.getElementById('lv-label').textContent='‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
  document.getElementById('sc').textContent='0';
}
function updateHdr(){
  document.getElementById('sc').textContent=score;
  document.getElementById('hi').textContent=hiScore;
  document.getElementById('lv-label').textContent=LV[curLevel]?.name||'';
  document.getElementById('back-btn').classList.add('vis');
}

document.getElementById('back-btn').addEventListener('pointerdown',e=>{
  e.preventDefault();initA();showMenu();
},{passive:false});

window.addEventListener('resize',layout);

// ‚îÄ‚îÄ Boot ‚Äî use requestAnimationFrame so DOM is fully painted before measuring ‚îÄ‚îÄ
try{hiScore=parseInt(localStorage.getItem('snakeHi')||'0',10);}catch(e){}
document.getElementById('hi').textContent=hiScore;

// Wait two frames so the dpad and header have real pixel dimensions
requestAnimationFrame(()=>requestAnimationFrame(()=>{
  layout();
  startRAF();
}));
</script>
</body>
</html>
