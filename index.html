<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Snake</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{
  width:100%;height:100%;overflow:hidden;
  background:#3d6b18;
  font-family:'Nunito',sans-serif;
  touch-action:none;user-select:none;
}
#shell{
  width:100%;height:100%;
  display:flex;flex-direction:column;align-items:center;
}

/* â”€â”€ HEADER â”€â”€ */
#hdr{
  width:100%;flex-shrink:0;
  background:#2e4f0e;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;
  height:50px;
  box-shadow:0 3px 10px rgba(0,0,0,.4);
  position:relative;z-index:10;
}
.hi{display:flex;align-items:center;gap:5px;color:#fff;font-size:18px;font-weight:900;}
.hi .ico{font-size:22px;line-height:1;}
#hdr-mid{display:flex;flex-direction:column;align-items:center;gap:1px;}
#lv-label{color:rgba(255,255,255,.65);font-size:10px;font-weight:800;letter-spacing:1.4px;text-transform:uppercase;}
#back-btn{
  background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.25);
  border-radius:8px;color:#fff;font-size:11px;font-weight:900;
  padding:3px 9px;cursor:pointer;font-family:'Nunito',sans-serif;
  letter-spacing:.6px;transition:background .1s,transform .07s;
  display:none;
}
#back-btn.vis{display:block;}
#back-btn:active{background:rgba(255,255,255,.3);transform:scale(.94);}

/* â”€â”€ BOARD â”€â”€ */
#board-area{
  flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  width:100%;
  padding:6px 8px 4px;
}
#board-frame{
  position:relative;flex-shrink:0;
  border-radius:6px;overflow:hidden;
  box-shadow:0 0 0 4px #2e4f0e,0 0 0 7px #1e3508,0 10px 30px rgba(0,0,0,.5);
}
canvas{display:block;}

/* â”€â”€ OVERLAYS â”€â”€ */
.ovl{
  position:absolute;inset:0;z-index:30;
  display:none;flex-direction:column;
  align-items:center;justify-content:center;
  gap:10px;padding:12px;
  background:rgba(14,28,3,.88);
  border-radius:6px;
}
.ovl.on{display:flex;}
.m-title{color:#fff;font-size:22px;font-weight:900;text-transform:uppercase;letter-spacing:2.5px;
  text-shadow:0 0 20px rgba(120,255,60,.4);}
.m-sub{color:rgba(255,255,255,.45);font-size:10px;font-weight:700;letter-spacing:1px;margin-top:-4px;}
.lv-list{display:flex;flex-direction:column;gap:6px;width:100%;}
.lv{
  background:#fff;border-radius:12px;
  padding:8px 12px;
  display:flex;align-items:center;gap:9px;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
  border-left:5px solid var(--c);
  transition:transform .08s,box-shadow .08s;
}
.lv:active{transform:scale(.96);}
.lv:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.3);}
.lv[data-lv="0"]{--c:#e05252;}.lv[data-lv="1"]{--c:#f5a623;}.lv[data-lv="2"]{--c:#4a90e9;}
.lv-badge{width:30px;height:30px;border-radius:50%;background:var(--c);color:#fff;
  font-size:14px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.lv-name{font-size:12px;font-weight:900;color:#222;text-transform:uppercase;letter-spacing:.4px;}
.lv-desc{font-size:9px;color:#aaa;margin-top:1px;line-height:1.3;}
.lv-ico{margin-left:auto;font-size:18px;}
.pop-card{
  background:#fff;border-radius:18px;padding:22px 32px;text-align:center;
  box-shadow:0 14px 40px rgba(0,0,0,.6);
  animation:pop .22s cubic-bezier(.34,1.56,.64,1) both;
}
.go-title{font-size:24px;font-weight:900;color:#333;}
.go-score{font-size:50px;font-weight:900;color:#e05252;line-height:1.1;}
.go-best{font-size:12px;color:#bbb;margin-top:2px;}
.go-restart{font-size:11px;color:#ccc;margin-top:6px;}
.lc-title{font-size:22px;font-weight:900;color:#3a7000;}
.lc-sub{font-size:12px;color:#888;margin-top:4px;}
.lc-btn{
  margin-top:12px;background:#3a7000;color:#fff;
  border:none;border-radius:999px;padding:10px 26px;
  font-size:14px;font-weight:800;cursor:pointer;
  font-family:'Nunito',sans-serif;
  box-shadow:0 4px 0 #1e4400;
  transition:transform .07s,box-shadow .07s;
}
.lc-btn:active{transform:translateY(3px);box-shadow:0 1px 0 #1e4400;}

/* Wait hint */
#wait-hint{
  position:absolute;bottom:10px;left:0;right:0;
  text-align:center;pointer-events:none;z-index:20;display:none;
}
#wait-hint span{
  background:rgba(0,0,0,.6);color:#fff;
  font-size:11px;font-weight:800;letter-spacing:.8px;
  padding:5px 14px;border-radius:20px;
  animation:bpulse 1.1s ease-in-out infinite;
}
@keyframes bpulse{0%,100%{opacity:.55}50%{opacity:1}}

/* flip flash */
#rflash{
  position:absolute;inset:0;z-index:22;pointer-events:none;
  background:radial-gradient(ellipse at center,rgba(255,200,0,.6),rgba(255,120,0,.1));
  opacity:0;border-radius:6px;
}

/* â”€â”€ DPAD â€” fills ALL remaining space â”€â”€ */
#dpad-wrap{
  flex:1;
  display:flex;align-items:center;justify-content:center;
  width:100%;
  min-height:0;
  padding:4px 12px 10px;
}
#dpad{
  display:grid;
  grid-template:". U ." "L C R" ". D .";
  grid-template-columns:1fr 1fr 1fr;
  grid-template-rows:1fr 1fr 1fr;
  gap:8px;
  width:100%;
  height:100%;
  max-width:420px;
  max-height:420px;
}
.dp{
  background:linear-gradient(150deg,#ffffff 0%,#dff0b8 100%);
  border:none;border-radius:22px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  box-shadow:0 7px 0 #1a5200,0 9px 22px rgba(0,0,0,.38);
  transition:box-shadow .05s,transform .05s,background .05s;
  touch-action:none;
  -webkit-user-select:none;
  width:100%;height:100%;
}
.dp:active,.dp.pr{
  box-shadow:0 2px 0 #1a5200,0 3px 8px rgba(0,0,0,.22);
  transform:translateY(5px);
  background:linear-gradient(150deg,#eef8d0 0%,#c8e098 100%);
}
.dp svg{width:40%;height:40%;fill:#1e4d00;filter:drop-shadow(0 1px 2px rgba(0,0,0,.18));}
#dp-C{grid-area:C;background:transparent;box-shadow:none;pointer-events:none;}
#dp-U{grid-area:U;}#dp-L{grid-area:L;}#dp-R{grid-area:R;}#dp-D{grid-area:D;}
@keyframes pop{from{opacity:0;transform:scale(.55);}to{opacity:1;transform:scale(1);}}
</style>
</head>
<body>
<div id="shell">
  <div id="hdr">
    <div class="hi"><span class="ico">ğŸ</span><span id="sc">0</span></div>
    <div id="hdr-mid">
      <div id="lv-label">SNAKE</div>
      <button id="back-btn">â† LEVELS</button>
    </div>
    <div class="hi"><span class="ico">ğŸ†</span><span id="hi">0</span></div>
  </div>

  <div id="board-area">
    <div id="board-frame">
      <div id="rflash"></div>
      <canvas id="gc"></canvas>
      <div id="wait-hint"><span>ğŸ‘† TAP A BUTTON TO START</span></div>

      <div class="ovl on" id="m-ovl">
        <div class="m-title">ğŸ Snake</div>
        <div class="m-sub">CHOOSE YOUR CHALLENGE</div>
        <div class="lv-list">
          <div class="lv" data-lv="0">
            <div class="lv-badge">1</div>
            <div><div class="lv-name">Closing In</div><div class="lv-desc">Walls grow with every apple eaten</div></div>
            <span class="lv-ico">ğŸ§±</span>
          </div>
          <div class="lv" data-lv="1">
            <div class="lv-badge">2</div>
            <div><div class="lv-name">Flipside</div><div class="lv-desc">Apple instantly reverses snake direction</div></div>
            <span class="lv-ico">ğŸ”„</span>
          </div>
          <div class="lv" data-lv="2">
            <div class="lv-badge">3</div>
            <div><div class="lv-name">Gauntlet</div><div class="lv-desc">Navigate the deadly fixed maze</div></div>
            <span class="lv-ico">ğŸŒ€</span>
          </div>
        </div>
      </div>

      <div class="ovl" id="go-ovl">
        <div class="pop-card">
          <div class="go-title">Game Over</div>
          <div class="go-score" id="go-sc">0</div>
          <div class="go-best" id="go-best"></div>
          <div class="go-restart">Restarting in <span id="go-cnt">3</span>sâ€¦</div>
        </div>
      </div>

      <div class="ovl" id="lc-ovl">
        <div class="pop-card">
          <div class="lc-title">ğŸ‰ Level Clear!</div>
          <div class="lc-sub" id="lc-sub"></div>
          <button class="lc-btn" id="lc-btn">Next Level â†’</button>
        </div>
      </div>
    </div>
  </div>

  <div id="dpad-wrap">
    <div id="dpad">
      <button class="dp" id="dp-U"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button>
      <button class="dp" id="dp-L"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L10.83 12l4.58 4.59L14 18l-6-6 6-6z"/></svg></button>
      <div id="dp-C"></div>
      <button class="dp" id="dp-R"><svg viewBox="0 0 24 24"><path d="M10 6l-1.41 1.41L13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
      <button class="dp" id="dp-D"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg></button>
    </div>
  </div>
</div>

<script>
const cvs    = document.getElementById('gc');
const ctx    = cvs.getContext('2d');
const rFlash = document.getElementById('rflash');
const waitHint = document.getElementById('wait-hint');

const GN = 14;
let GS = 28;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = 'MENU'; // MENU | WAITING | PLAYING | GO | LC | PAUSED
let snake, snakePrev, dir, nextDir;
let foods, walls;
let score=0, hiScore=0, curLevel=0;
let tickMs=200, tickId=null;
let lastTick=0, dirLock=false;
let rafId=null, T=0;
let docHidden=false;

// VFX
let particles=[], shockwaves=[];
let eatBounce=1, eatBounceV=0;
let bodyGlow=0, revGlow=0;
let shakeT=0, shakeX=0, shakeY=0;
let blinkT=0, nextBlink=Date.now()+2200;
const BLINK_DUR=110;

// â”€â”€ Levels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LV=[
  {name:'CLOSING IN',type:'closein',clr:'#e05252',spd:200,min:80,step:5},
  {name:'FLIPSIDE',  type:'reverse',clr:'#f5a623',spd:215,min:85,step:4},
  {name:'GAUNTLET',  type:'maze',   clr:'#4a90e9',spd:230,min:95,step:5,
    grid:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,1,1,1,0,0,0,0,1,1,1,0,1],
      [1,0,1,0,0,0,0,0,0,0,0,1,0,1],
      [1,0,1,0,1,1,0,0,1,1,0,1,0,1],
      [1,0,0,0,1,0,0,0,0,1,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,1,0,0,0,0,1,0,0,0,1],
      [1,0,1,0,1,1,0,0,1,1,0,1,0,1],
      [1,0,1,0,0,0,0,0,0,0,0,1,0,1],
      [1,0,1,1,1,0,0,0,0,1,1,1,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ]
  }
];

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let AC,audioOn=false;
function initA(){
  if(audioOn)return;
  try{AC=new(window.AudioContext||window.webkitAudioContext)();audioOn=true;}catch(e){}
}
function tone(f,type,dur,vol=0.09,fend){
  if(!audioOn||docHidden)return;
  try{
    const o=AC.createOscillator(),g=AC.createGain();
    o.connect(g);g.connect(AC.destination);
    o.type=type;o.frequency.setValueAtTime(f,AC.currentTime);
    if(fend)o.frequency.exponentialRampToValueAtTime(fend,AC.currentTime+dur);
    g.gain.setValueAtTime(vol,AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+dur);
    o.start();o.stop(AC.currentTime+dur);
  }catch(e){}
}
const sfxEat  =()=>{tone(523,'sine',.07,.18);setTimeout(()=>tone(784,'sine',.06,.12),55);};
const sfxFlip =()=>{tone(880,'sine',.06,.1);setTimeout(()=>tone(440,'sawtooth',.2,.07,110),70);};
const sfxWall =()=>tone(110,'square',.12,.05);
const sfxDie  =()=>{tone(440,'sawtooth',.55,.14,75);setTimeout(()=>tone(180,'sawtooth',.3,.08,60),130);};
const sfxStart=()=>[330,440,660].forEach((f,i)=>setTimeout(()=>tone(f,'square',.1,.07),i*80));
const sfxNear =()=>tone(1400,'sine',.04,.03);

// â”€â”€ Background pause â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('visibilitychange',()=>{
  docHidden=document.hidden;
  if(document.hidden){
    if(state==='PLAYING'){clearInterval(tickId);state='PAUSED';}
  } else {
    if(state==='PAUSED'){
      lastTick=Date.now();
      tickId=setInterval(tick,tickMs);
      state='PLAYING';
    }
  }
});

// â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function layout(){
  const hdrH=document.getElementById('hdr').offsetHeight||50;
  const remaining=window.innerHeight-hdrH;
  // Board takes up ~40% of remaining, dpad gets ~60%
  const boardMaxH=Math.floor(remaining*0.40)-18;
  const boardMaxW=window.innerWidth-20;
  GS=Math.max(10,Math.min(Math.floor(boardMaxH/GN),Math.floor(boardMaxW/GN)));
  const W=GN*GS,H=GN*GS;
  cvs.width=W;cvs.height=H;
  const frame=document.getElementById('board-frame');
  frame.style.width=W+'px';frame.style.height=H+'px';
  const ba=document.getElementById('board-area');
  ba.style.height=(H+18)+'px';
  drawFrame();
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const eio=t=>t<.5?2*t*t:-1+(4-2*t)*t;
const rndInt=(a,b)=>Math.floor(Math.random()*(b-a))+a;

// â”€â”€ Collision â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hitWall(p){
  const lv=LV[curLevel];
  if(lv.type==='maze'){
    if(p.x<0||p.x>=GN||p.y<0||p.y>=GN)return true;
    return lv.grid[p.y][p.x]===1;
  }
  if(p.x<1||p.x>=GN-1||p.y<1||p.y>=GN-1)return true;
  if(lv.type==='closein'&&walls.some(w=>w.x===p.x&&w.y===p.y))return true;
  return false;
}
function hitSelf(p,skip=0){
  for(let i=skip;i<snake.length;i++)if(snake[i].x===p.x&&snake[i].y===p.y)return true;
  return false;
}

// â”€â”€ Food â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function freeSpot(){
  const lv=LV[curLevel];
  if(lv.type==='maze'){
    const e=[];
    for(let r=1;r<GN-1;r++)for(let c=1;c<GN-1;c++){
      if(lv.grid[r][c]===0&&!snake.some(s=>s.x===c&&s.y===r)&&!foods.some(f=>f.x===c&&f.y===r))
        e.push({x:c,y:r});
    }
    return e.length?e[rndInt(0,e.length)]:null;
  }
  for(let t=0;t<3000;t++){
    const p={x:rndInt(1,GN-1),y:rndInt(1,GN-1)};
    if(!snake.some(s=>s.x===p.x&&s.y===p.y)&&
       !walls.some(w=>w.x===p.x&&w.y===p.y)&&
       !foods.some(f=>f.x===p.x&&f.y===p.y))return p;
  }
  return null;
}
function manageFood(){
  const want=snake.length>20?3:snake.length>10?2:1;
  while(foods.length<want){const s=freeSpot();if(s)foods.push(s);else break;}
}

// â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startLv(idx){initA();sfxStart();curLevel=idx;score=0;doLoad();}
function doLoad(){
  const lv=LV[curLevel];
  let sx=6,sy=7;
  if(lv.type==='maze'){
    outer:for(let r=1;r<GN-1;r++)for(let c=4;c<GN-1;c++){
      if(lv.grid[r][c]===0&&lv.grid[r][c-1]===0&&lv.grid[r][c-2]===0){sy=r;sx=c;break outer;}
    }
  }
  snake=[{x:sx,y:sy},{x:sx-1,y:sy},{x:sx-2,y:sy}];
  snakePrev=snake.map(s=>({...s}));
  dir={x:1,y:0};nextDir={x:0,y:0};
  foods=[];walls=[];particles=[];shockwaves=[];
  eatBounce=1;eatBounceV=0;bodyGlow=0;revGlow=0;shakeT=0;dirLock=false;
  tickMs=lv.spd;
  manageFood();
  state='WAITING';
  closeOvl();
  waitHint.style.display='block';
  clearInterval(tickId);
  updateHdr();
}

// â”€â”€ Tick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick(){
  if(state!=='PLAYING')return;
  dirLock=false;
  snakePrev=snake.map(s=>({...s}));
  lastTick=Date.now();

  if(nextDir.x!==0||nextDir.y!==0){
    const rev=snake.length>1&&((nextDir.x===-dir.x&&nextDir.y===0)||(nextDir.y===-dir.y&&nextDir.x===0));
    if(!rev)dir={...nextDir};
    nextDir={x:0,y:0};
  }

  const head={x:snake[0].x+dir.x,y:snake[0].y+dir.y};
  if(hitWall(head)||hitSelf(head,1)){die();return;}

  snake.unshift(head);
  const eatIdx=foods.findIndex(f=>f.x===head.x&&f.y===head.y);

  if(eatIdx!==-1){
    sfxEat();
    score+=10;if(score>hiScore)hiScore=score;
    foods.splice(eatIdx,1);
    eatBounceV=0.15;bodyGlow=1;
    emitEat(head.x,head.y);
    const lv=LV[curLevel];
    if(lv.type==='closein')spawnWall();
    else if(lv.type==='reverse')doReverse();
    else if(lv.type==='maze'){
      const total=lv.grid.flat().filter(c=>c===0).length;
      if(snake.length>=total){lvDone();return;}
    }
    speedUp();updateHdr();manageFood();
  } else {
    snake.pop();
  }
  const h=snake[0];
  if(foods.some(f=>Math.abs(f.x-h.x)+Math.abs(f.y-h.y)===1))sfxNear();
}

// â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function die(){
  sfxDie();emitDeath(snake[0].x,snake[0].y);
  shakeT=0.65;clearInterval(tickId);state='GO';
  waitHint.style.display='none';
  try{localStorage.setItem('snakeHi',hiScore);}catch(e){}
  document.getElementById('go-sc').textContent=score;
  document.getElementById('go-best').textContent=`Best: ${hiScore}`;
  document.getElementById('go-ovl').classList.add('on');
  let c=3;document.getElementById('go-cnt').textContent=c;
  const iv=setInterval(()=>{
    c--;document.getElementById('go-cnt').textContent=c;
    if(c<=0){
      clearInterval(iv);
      document.getElementById('go-ovl').classList.remove('on');
      if(state==='GO'){score=0;doLoad();}
    }
  },1000);
}
function lvDone(){
  clearInterval(tickId);state='LC';
  waitHint.style.display='none';
  document.getElementById('lc-ovl').classList.add('on');
  document.getElementById('lc-sub').textContent=`Score: ${score} pts ğŸ†`;
  const btn=document.getElementById('lc-btn'),nxt=curLevel+1;
  if(nxt<LV.length){btn.textContent='Next Level â†’';btn.onclick=()=>{score=0;curLevel=nxt;doLoad();};}
  else{btn.textContent='ğŸ† Play Again';btn.onclick=()=>{score=0;curLevel=0;doLoad();};}
}
function doReverse(){
  sfxFlip();
  snake.reverse();snakePrev=snake.map(s=>({...s}));
  if(snake.length>1)dir={x:snake[0].x-snake[1].x,y:snake[0].y-snake[1].y};
  else dir={x:-dir.x,y:-dir.y};
  nextDir={x:0,y:0};revGlow=1;
  rFlash.style.transition='none';rFlash.style.opacity='1';
  requestAnimationFrame(()=>{rFlash.style.transition='opacity .4s';rFlash.style.opacity='0';});
  snake.forEach((s,i)=>{if(i%3===0)emitWarp(s.x,s.y);});
}
function spawnWall(){
  const lim=(GN-2)*(GN-2)-snake.length-foods.length-6;
  if(walls.length<lim){
    const w=freeSpot();
    if(w){walls.push(w);sfxWall();shockwaves.push({x:w.x,y:w.y,t:0});}
  }
}
function speedUp(){
  const lv=LV[curLevel];
  const ns=Math.max(lv.min,lv.spd-Math.floor(score/20)*lv.step);
  if(ns!==tickMs){tickMs=ns;clearInterval(tickId);tickId=setInterval(tick,tickMs);}
}

// â”€â”€ Particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function emitEat(gx,gy){
  const cx=gx*GS+GS/2,cy=gy*GS+GS/2;
  for(let i=0;i<16;i++){
    const a=Math.random()*Math.PI*2,sp=1.5+Math.random()*5;
    particles.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      life:.8+Math.random()*.4,sz:1.5+Math.random()*3.5,col:`hsl(${rndInt(80,150)},90%,58%)`});
  }
}
function emitDeath(gx,gy){
  const cx=gx*GS+GS/2,cy=gy*GS+GS/2;
  for(let i=0;i<32;i++){
    const a=Math.random()*Math.PI*2,sp=1.5+Math.random()*8;
    particles.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      life:.9+Math.random()*.6,sz:2+Math.random()*5,col:`hsl(${rndInt(0,50)},95%,55%)`});
  }
}
function emitWarp(gx,gy){
  const cx=gx*GS+GS/2,cy=gy*GS+GS/2;
  for(let i=0;i<6;i++){
    const a=Math.random()*Math.PI*2,sp=.5+Math.random()*3;
    particles.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      life:.5+Math.random()*.3,sz:1.5+Math.random()*2.5,col:'hsl(45,100%,62%)'});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAW ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawFrame(){
  if(!cvs.width||!cvs.height)return;
  T=Date.now()*.001;

  eatBounceV-=(eatBounce-1)*.38;eatBounceV*=.68;
  eatBounce=clamp(eatBounce+eatBounceV,.72,1.3);
  if(bodyGlow>0)bodyGlow=Math.max(0,bodyGlow-.022);
  if(revGlow>0)revGlow=Math.max(0,revGlow-.03);
  if(shakeT>0){
    shakeT=Math.max(0,shakeT-.04);
    shakeX=(Math.random()-.5)*GS*.42*shakeT;
    shakeY=(Math.random()-.5)*GS*.42*shakeT;
  } else {shakeX=shakeY=0;}

  ctx.save();
  ctx.translate(shakeX,shakeY);
  drawBoard();
  drawWalls();
  drawShockwaves();
  if(state==='PLAYING'||state==='GO'||state==='WAITING'||state==='PAUSED'){
    drawFood();
    drawSnake();
    drawParticles();
  }
  ctx.restore();
}

function drawBoard(){
  for(let r=0;r<GN;r++)for(let c=0;c<GN;c++){
    ctx.fillStyle=(r+c)%2===0?'#aad751':'#a2d049';
    ctx.fillRect(c*GS,r*GS,GS,GS);
  }
}

const WP=[[0,1,2,1],[1,2,1,0],[2,1,0,1],[1,0,1,2]];
const WC=['#578a00','#4a7800','#3c6300'];
function wCell(x,y){
  const P=GS/4;
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    ctx.fillStyle=WC[WP[r][c]];ctx.fillRect(x+c*P,y+r*P,P,P);
  }
  ctx.fillStyle='rgba(255,255,255,.07)';
  ctx.fillRect(x,y,GS,2);ctx.fillRect(x,y,2,GS);
  ctx.fillStyle='rgba(0,0,0,.12)';
  ctx.fillRect(x,y+GS-2,GS,2);ctx.fillRect(x+GS-2,y,2,GS);
}
function drawWalls(){
  if(state==='MENU')return;
  const lv=LV[curLevel];
  if(lv.type==='maze'){
    lv.grid.forEach((row,r)=>row.forEach((cell,c)=>{if(cell===1)wCell(c*GS,r*GS);}));
  } else {
    for(let i=0;i<GN;i++){
      wCell(i*GS,0);wCell(i*GS,(GN-1)*GS);
      if(i>0&&i<GN-1){wCell(0,i*GS);wCell((GN-1)*GS,i*GS);}
    }
    walls.forEach(w=>wCell(w.x*GS,w.y*GS));
  }
}

function drawShockwaves(){
  shockwaves=shockwaves.filter(s=>s.t<1);
  shockwaves.forEach(s=>{
    s.t+=.05;const a=(1-s.t)*.75,r=s.t*GS*5.5;
    ctx.save();
    ctx.strokeStyle=`rgba(200,255,80,${a})`;ctx.lineWidth=2.5;
    ctx.shadowBlur=14;ctx.shadowColor=`rgba(160,255,0,${a})`;
    ctx.beginPath();ctx.arc(s.x*GS+GS/2,s.y*GS+GS/2,r,0,Math.PI*2);ctx.stroke();
    ctx.restore();
  });
}

function drawFood(){
  const pulse=1+Math.sin(T*5.5)*.05;
  foods.forEach(f=>{
    const fx=f.x*GS+GS/2,fy=f.y*GS+GS/2,r=GS*.38*pulse;
    ctx.save();
    // outer glow
    const grd=ctx.createRadialGradient(fx,fy,0,fx,fy,r*1.7);
    grd.addColorStop(0,'rgba(255,50,50,.22)');grd.addColorStop(1,'rgba(255,50,50,0)');
    ctx.fillStyle=grd;ctx.beginPath();ctx.arc(fx,fy,r*1.7,0,Math.PI*2);ctx.fill();
    // body
    ctx.shadowColor='rgba(100,0,0,.4)';ctx.shadowBlur=8;ctx.shadowOffsetY=3;
    const bg=ctx.createRadialGradient(fx-r*.28,fy-r*.22,r*.05,fx,fy,r);
    bg.addColorStop(0,'#ff4444');bg.addColorStop(.7,'#cc0000');bg.addColorStop(1,'#880000');
    ctx.fillStyle=bg;
    ctx.beginPath();ctx.arc(fx,fy,r,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.shadowOffsetY=0;
    // highlight
    ctx.fillStyle='rgba(255,160,160,.62)';
    ctx.beginPath();ctx.ellipse(fx-r*.22,fy-r*.25,r*.38,r*.24,-.35,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,235,235,.82)';
    ctx.beginPath();ctx.arc(fx-r*.08,fy-r*.34,r*.13,0,Math.PI*2);ctx.fill();
    // stem
    ctx.strokeStyle='#5a3200';ctx.lineWidth=Math.max(1.5,GS*.06);ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(fx+r*.05,fy-r*.8);
    ctx.quadraticCurveTo(fx+r*.5,fy-r*1.35,fx+r*.35,fy-r*.95);ctx.stroke();
    ctx.fillStyle='#4caf50';
    ctx.beginPath();ctx.ellipse(fx+r*.28,fy-r*.93,r*.28,r*.15,.45,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });
}

// â”€â”€ SNAKE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSnake(){
  if(!snake||snake.length<1)return;
  const elapsed=Date.now()-lastTick;
  const et=(state==='WAITING'||state==='PAUSED')?0:eio(clamp(elapsed/tickMs,0,1));

  // Interpolated pixel centres
  const pts=snake.map((s,i)=>{
    const p=snakePrev[i]||snakePrev[snakePrev.length-1]||s;
    return{x:lerp(p.x,s.x,et)*GS+GS/2, y:lerp(p.y,s.y,et)*GS+GS/2};
  });

  const sw=GS*.78*eatBounce;

  // Shadow layer
  ctx.save();ctx.translate(GS*.055,GS*.09);
  strokeCurve(pts,sw*1.04,'rgba(0,0,0,.22)');
  ctx.restore();

  // Glow on eat / flip
  const g=Math.max(bodyGlow,revGlow);
  if(g>.01){
    ctx.save();
    ctx.shadowBlur=22+g*20;
    ctx.shadowColor=revGlow>bodyGlow?`rgba(255,190,0,${g*.9})`:`rgba(50,185,255,${g*.9})`;
    strokeCurve(pts,sw*1.2,`rgba(100,170,255,${g*.07})`);
    ctx.restore();
  }

  // Body layers (dark â†’ mid â†’ sheen stripe)
  strokeCurve(pts,sw,'#0f2870');
  strokeCurve(pts,sw*.82,'#3a78e5');
  // Animated interior shimmer
  strokeCurve(pts,sw*.28,`rgba(190,225,255,${.35+Math.sin(T*3.2)*.1})`);

  // Scale marks
  drawScales(pts,sw);

  // Head
  drawHead(pts);
}

// â”€ Smooth bezier path (midpoint quadratic technique) â”€â”€â”€â”€â”€
// Each segment's control point is the actual grid node;
// endpoints are midpoints between nodes â†’ perfectly smooth
// S-curves through every right-angle turn.
function strokeCurve(pts,lw,col){
  if(pts.length<2)return;
  ctx.save();
  ctx.strokeStyle=col;ctx.lineWidth=lw;
  ctx.lineCap='round';ctx.lineJoin='round';
  ctx.beginPath();
  ctx.moveTo(pts[0].x,pts[0].y);

  if(pts.length===2){
    ctx.lineTo(pts[1].x,pts[1].y);
  } else {
    // Head â†’ midpoint between [0] and [1]
    ctx.lineTo((pts[0].x+pts[1].x)*.5,(pts[0].y+pts[1].y)*.5);
    // Middle: quadratic through each actual point
    for(let i=1;i<pts.length-1;i++){
      const mx=(pts[i].x+pts[i+1].x)*.5;
      const my=(pts[i].y+pts[i+1].y)*.5;
      ctx.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);
    }
    // Last â†’ tail tip
    ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);
  }
  ctx.stroke();ctx.restore();
}

// Oval scale marks along body
function drawScales(pts,sw){
  if(pts.length<3)return;
  ctx.save();ctx.fillStyle='rgba(255,255,255,.055)';
  for(let i=2;i<pts.length-1;i+=2){
    const prev=pts[i-1],cur=pts[i];
    const ang=Math.atan2(cur.y-prev.y,cur.x-prev.x);
    const sr=sw*.28;
    ctx.save();
    ctx.translate(cur.x,cur.y);ctx.rotate(ang);
    ctx.beginPath();ctx.ellipse(0,0,sr*1.15,sr*.58,0,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
  ctx.restore();
}

function drawHead(pts){
  if(!pts.length)return;
  const hx=pts[0].x,hy=pts[0].y;
  const r=(GS*.78/2)*eatBounce;
  const eo=getEO();
  const d=(dir.x===0&&dir.y===0)?{x:1,y:0}:dir;
  const eR=r*.33,eOff=r*.39;
  let e1x,e1y,e2x,e2y;
  if(d.x===1)      {e1x=hx+r*.1;e1y=hy-eOff;e2x=hx+r*.1;e2y=hy+eOff;}
  else if(d.x===-1){e1x=hx-r*.1;e1y=hy-eOff;e2x=hx-r*.1;e2y=hy+eOff;}
  else if(d.y===1) {e1x=hx-eOff;e1y=hy+r*.1;e2x=hx+eOff;e2y=hy+r*.1;}
  else             {e1x=hx-eOff;e1y=hy-r*.1;e2x=hx+eOff;e2y=hy-r*.1;}

  // Tongue
  if(Math.sin(T*4.8)>.55&&eo>.25){
    const tk={x:hx+d.x*r*1.4,y:hy+d.y*r*1.4};
    const fl=r*.38,perp={x:-d.y*.55,y:d.x*.55};
    ctx.save();
    ctx.strokeStyle='#e83030';ctx.lineWidth=Math.max(1,r*.13);ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(hx+d.x*r*.88,hy+d.y*r*.88);ctx.lineTo(tk.x,tk.y);ctx.stroke();
    ctx.beginPath();ctx.moveTo(tk.x,tk.y);
    ctx.lineTo(tk.x+d.x*fl+perp.x*fl,tk.y+d.y*fl+perp.y*fl);ctx.stroke();
    ctx.beginPath();ctx.moveTo(tk.x,tk.y);
    ctx.lineTo(tk.x+d.x*fl-perp.x*fl,tk.y+d.y*fl-perp.y*fl);ctx.stroke();
    ctx.restore();
  }

  // Eyes
  [[e1x,e1y],[e2x,e2y]].forEach(([ex,ey])=>{
    const eH=Math.max(eR*.05,eR*eo);
    ctx.save();
    ctx.fillStyle='white';ctx.shadowBlur=4;ctx.shadowColor='rgba(0,0,0,.3)';
    ctx.beginPath();ctx.ellipse(ex,ey,eR,eH,0,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;
    if(eo>.08){
      ctx.fillStyle='#111';
      ctx.beginPath();ctx.ellipse(ex+d.x*eR*.26,ey+d.y*eR*.26,eR*.54,eH*.62,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.82)';
      ctx.beginPath();ctx.arc(ex-eR*.2,ey-eH*.28,eR*.18,0,Math.PI*2);ctx.fill();
    }
    ctx.restore();
  });
}

function getEO(){
  const now=Date.now();
  if(now>nextBlink){blinkT=now;nextBlink=now+BLINK_DUR+1200+Math.random()*3200;}
  const t=(now-blinkT)/BLINK_DUR;
  if(t>=0&&t<=1)return t<.5?1-t*2:(t-.5)*2;
  return 1;
}

function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vx*=.84;p.vy*=.84;p.vy+=.06;p.life-=.025;
    if(p.life<=0){particles.splice(i,1);continue;}
    ctx.globalAlpha=clamp(p.life,0,1);
    ctx.fillStyle=p.col;
    ctx.beginPath();ctx.arc(p.x,p.y,p.sz*.5,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
  }
}

// â”€â”€ RAF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startRAF(){
  function f(){drawFrame();rafId=requestAnimationFrame(f);}
  if(rafId)cancelAnimationFrame(rafId);
  rafId=requestAnimationFrame(f);
}

// â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDir(d){
  initA();
  if(state==='WAITING'){
    // Block reverse of starting direction
    if(d.x===-dir.x&&d.y===0)return;
    if(d.y===-dir.y&&d.x===0)return;
    waitHint.style.display='none';
    dir={...d};
    state='PLAYING';
    lastTick=Date.now();
    clearInterval(tickId);
    tickId=setInterval(tick,tickMs);
    return;
  }
  if(state!=='PLAYING')return;
  if(snake.length>1&&((d.x===-dir.x&&d.y===0)||(d.y===-dir.y&&d.x===0)))return;
  if(!dirLock){nextDir={...d};dirLock=true;}
}

function bindDP(id,d){
  const el=document.getElementById(id);
  el.addEventListener('pointerdown',e=>{e.preventDefault();setDir(d);el.classList.add('pr');},{passive:false});
  el.addEventListener('pointerup',()=>el.classList.remove('pr'),{passive:true});
  el.addEventListener('pointercancel',()=>el.classList.remove('pr'),{passive:true});
  el.addEventListener('pointerleave',()=>el.classList.remove('pr'),{passive:true});
}
bindDP('dp-U',{x:0,y:-1});
bindDP('dp-D',{x:0,y:1});
bindDP('dp-L',{x:-1,y:0});
bindDP('dp-R',{x:1,y:0});

window.addEventListener('keydown',e=>{
  initA();
  if(state==='MENU'){
    if(e.key==='1'){closeOvl();startLv(0);}
    if(e.key==='2'){closeOvl();startLv(1);}
    if(e.key==='3'){closeOvl();startLv(2);}
    return;
  }
  const map={ArrowUp:'U',w:'U',ArrowDown:'D',s:'D',ArrowLeft:'L',a:'L',ArrowRight:'R',d:'R'};
  const dirs={U:{x:0,y:-1},D:{x:0,y:1},L:{x:-1,y:0},R:{x:1,y:0}};
  if(map[e.key])setDir(dirs[map[e.key]]);
});

let tx=0,ty=0;
cvs.addEventListener('touchstart',e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY;},{passive:true});
cvs.addEventListener('touchend',e=>{
  initA();
  const dx=e.changedTouches[0].clientX-tx,dy=e.changedTouches[0].clientY-ty;
  if(Math.abs(dx)<8&&Math.abs(dy)<8)return;
  Math.abs(dx)>Math.abs(dy)?setDir(dx>0?{x:1,y:0}:{x:-1,y:0}):setDir(dy>0?{x:0,y:1}:{x:0,y:-1});
},{passive:true});

document.querySelectorAll('.lv').forEach(card=>{
  card.addEventListener('pointerdown',e=>{
    e.preventDefault();initA();closeOvl();startLv(parseInt(card.dataset.lv));
  },{passive:false});
});

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeOvl(){['m-ovl','go-ovl','lc-ovl'].forEach(id=>document.getElementById(id).classList.remove('on'));}
function showMenu(){
  clearInterval(tickId);state='MENU';score=0;
  waitHint.style.display='none';
  document.getElementById('m-ovl').classList.add('on');
  document.getElementById('back-btn').classList.remove('vis');
  document.getElementById('lv-label').textContent='SNAKE';
  document.getElementById('sc').textContent='0';
}
function updateHdr(){
  document.getElementById('sc').textContent=score;
  document.getElementById('hi').textContent=hiScore;
  document.getElementById('lv-label').textContent=LV[curLevel]?.name||'';
  document.getElementById('back-btn').classList.add('vis');
}
document.getElementById('back-btn').addEventListener('pointerdown',e=>{
  e.preventDefault();initA();showMenu();
},{passive:false});

window.addEventListener('resize',layout);

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try{hiScore=parseInt(localStorage.getItem('snakeHi')||'0',10);}catch(e){}
document.getElementById('hi').textContent=hiScore;
requestAnimationFrame(()=>requestAnimationFrame(()=>{layout();startRAF();}));
</script>
</body>
</html>
